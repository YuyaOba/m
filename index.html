<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>めるもキャッチ！タイムアタック</title>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: linear-gradient(180deg, #fff7fb 0%, #ffe6f0 100%);
      touch-action: none;
      font-family: "Zen Maru Gothic", sans-serif;
    }
    #score, #time, #stock {
      position: absolute;
      left: 14px;
      font-size: 22px;
      color: #ff66aa;
      text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
      user-select: none;
      font-weight: 600;
      letter-spacing: 1px;
    }
    #score { top: 10px; }
    #time { top: 42px; }
    #stock { top: 74px; }
    #message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 46px;
      color: #ff66aa;
      font-weight: bold;
      display: none;
      text-align: center;
      text-shadow: 3px 3px 6px rgba(255, 182, 193, 0.6);
      animation: pop 0.5s ease;
    }
    @keyframes pop {
      0% { transform: translate(-50%, -50%) scale(0.6); opacity: 0; }
      60% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    canvas { cursor: pointer; }
  </style>
</head>
<body>

<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500&family=Potta+One&display=swap" rel="stylesheet">

<div id="score">スコア：0</div>
<div id="time">のこり：60秒</div>
<div id="stock">ストック：め0 る0 も0</div>
<div id="message"></div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let w = (canvas.width = window.innerWidth);
let h = (canvas.height = window.innerHeight);

const player = {
  x: w / 2,
  y: h - 70,
  width: Math.min(w * 0.22, 80),
  height: 16,
  color: "#ff8ec8",
  radius: 8
};

const plusKana = ["め", "る", "も"];
const minusKana = ["ぬ", "ろ"];
const allKana = [...plusKana, ...minusKana];

let letters = [];
let score = 0;
let timeLeft = 60;
let stock = { "め": 0, "る": 0, "も": 0 };
let gameActive = true;

const popSound = new Audio("https://cdn.jsdelivr.net/gh/joshwcomeau/assets/sounds/pop.mp3");
let soundEnabled = false;

function enableSound() {
  if (!soundEnabled) {
    popSound.play().then(() => {
      popSound.pause();
      popSound.currentTime = 0;
      soundEnabled = true;
    }).catch(() => {});
  }
}

function showMessage(text, color = "#ff66aa") {
  const msg = document.getElementById("message");
  msg.textContent = text;
  msg.style.color = color;
  msg.style.display = "block";
  msg.style.animation = "pop 0.5s ease";
  setTimeout(() => (msg.style.display = "none"), 500);
}

function spawnLetter() {
  if (!gameActive) return;
  letters.push({
    x: Math.random() * (w - 40),
    y: -40,
    text: allKana[Math.floor(Math.random() * allKana.length)],
    speed: 2 + Math.random() * 3
  });
}

function drawRoundedRect(x, y, width, height, radius, color) {
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.lineTo(x + width - radius, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
  ctx.lineTo(x + width, y + height - radius);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
  ctx.lineTo(x + radius, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
  ctx.lineTo(x, y + radius);
  ctx.quadraticCurveTo(x, y, x + radius, y);
  ctx.closePath();
  ctx.fill();
}

function update() {
  ctx.clearRect(0, 0, w, h);
  drawRoundedRect(player.x - player.width / 2, player.y, player.width, player.height, player.radius, player.color);

  ctx.font = "34px 'Zen Maru Gothic', sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";

  for (let i = letters.length - 1; i >= 0; i--) {
    const l = letters[i];

    l.y += l.speed;

    ctx.fillStyle = plusKana.includes(l.text) ? "#ff66aa" : "#666";
    ctx.fillText(l.text, l.x, l.y);

    const distX = Math.abs(l.x - player.x);
    const hitRangeMinus = player.width * 0.7;

    // ✅ め・る・も → 「文字に触れたら即カウント」
    if (plusKana.includes(l.text)) {
      const overlapX = distX <= player.width / 2;
      const overlapY = l.y + 20 >= player.y && l.y - 20 <= player.y + player.height;
      if (overlapX && overlapY) {
        stock[l.text]++;
        showMessage(l.text + "＋", "#ff66aa");
        letters.splice(i, 1);
        updateDisplay();
        continue;
      }
    }

    // ✅ ぬ・ろ → バーを「触れた瞬間」だけ判定（バー下はノーカン）
    if (minusKana.includes(l.text)) {
      const prevY = l.y - l.speed;
      const justTouched = prevY + 20 < player.y && l.y + 20 >= player.y;
      if (justTouched && distX <= hitRangeMinus / 2) {
        score = Math.max(0, score - 1);
        showMessage("－1", "#6699ff");
        letters.splice(i, 1);
        updateDisplay();
        continue;
      }
    }

    if (l.y > h + 30) letters.splice(i, 1);
  }

  if (stock["め"] > 0 && stock["る"] > 0 && stock["も"] > 0) {
    stock["め"]--; stock["る"]--; stock["も"]--;
    score++;
    showMessage("めるも完成！＋1✨", "#ff3399");
    if (soundEnabled) {
      popSound.currentTime = 0;
      popSound.play().catch(() => {});
    }
    updateDisplay();
  }

  if (gameActive) requestAnimationFrame(update);
}

function updateDisplay() {
  document.getElementById("score").textContent = `スコア：${score}`;
  document.getElementById("stock").textContent =
    `ストック：め${stock["め"]} る${stock["る"]} も${stock["も"]}`;
}

function countdown() {
  const timer = setInterval(() => {
    if (!gameActive) return clearInterval(timer);
    timeLeft--;
    document.getElementById("time").textContent = `のこり：${timeLeft}秒`;
    if (timeLeft <= 0) {
      gameActive = false;
      document.getElementById("message").textContent = `終了！スコア：${score}`;
      document.getElementById("message").style.display = "block";
      clearInterval(timer);
    }
  }, 1000);
}

window.addEventListener("touchstart", enableSound, { once: true });
window.addEventListener("mousedown", enableSound, { once: true });

window.addEventListener("touchmove", (e) => { player.x = e.touches[0].clientX; });
window.addEventListener("mousemove", (e) => { player.x = e.clientX; });

setInterval(spawnLetter, 800);
update();
countdown();
</script>

</body>
</html>
